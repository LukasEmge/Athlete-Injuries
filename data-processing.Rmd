---
title: "data_processing"
author: "Lukas Emge"
date: "10/14/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(janitor)
library(ggplot2)
library(grid)
library(gridExtra)
library(rstanarm)
library(bayesplot)
```

```{r}
data_defense2017 <- read_csv("raw_data/2017Defense.csv", 
                         col_types = cols(
  Rk = col_double(),
  Year = col_double(),
  Player = col_character(),
  Pos = col_character(),
  AV = col_double(),
  School = col_character(),
  College = col_character(),
  Height = col_character(),
  Wt = col_double(),
  `40YD` = col_double(),
  Vertical = col_double(),
  BenchReps = col_double(),
  `Broad Jump` = col_double(),
  `3Cone` = col_double(),
  Shuttle = col_double(),
  `Drafted (tm/rnd/yr)` = col_character()
)) %>% 
  clean_names()

data_offense2017 <- read_csv("raw_data/2017Offense.csv",
                         col_types = cols(
  Rk = col_double(),
  Year = col_double(),
  Player = col_character(),
  Pos = col_character(),
  AV = col_double(),
  School = col_character(),
  College = col_character(),
  Height = col_character(),
  Wt = col_double(),
  `40YD` = col_double(),
  Vertical = col_double(),
  BenchReps = col_double(),
  `Broad Jump` = col_double(),
  `3Cone` = col_double(),
  Shuttle = col_double(),
  `Drafted (tm/rnd/yr)` = col_character()
)) %>% 
  clean_names()



data2017 <- full_join(data_defense2017, data_offense2017, 
                      by = c("rk", "year", "player","pos", "av", "school", 
                             "college", "height", "wt", "x40yd", "vertical", 
                             "bench_reps", "broad_jump", "x3cone", "shuttle", 
                             "drafted_tm_rnd_yr"))

data_defense2016 <- read_csv("raw_data/2016Defense.csv", 
                         col_types = cols(
  Rk = col_double(),
  Year = col_double(),
  Player = col_character(),
  Pos = col_character(),
  AV = col_double(),
  School = col_character(),
  College = col_character(),
  Height = col_character(),
  Wt = col_double(),
  `40YD` = col_double(),
  Vertical = col_double(),
  BenchReps = col_double(),
  `Broad Jump` = col_double(),
  `3Cone` = col_double(),
  Shuttle = col_double(),
  `Drafted (tm/rnd/yr)` = col_character()
)) %>% 
  clean_names()

data_offense2016 <- read_csv("raw_data/2016Offense.csv",
                         col_types = cols(
  Rk = col_double(),
  Year = col_double(),
  Player = col_character(),
  Pos = col_character(),
  AV = col_double(),
  School = col_character(),
  College = col_character(),
  Height = col_character(),
  Wt = col_double(),
  `40YD` = col_double(),
  Vertical = col_double(),
  BenchReps = col_double(),
  `Broad Jump` = col_double(),
  `3Cone` = col_double(),
  Shuttle = col_double(),
  `Drafted (tm/rnd/yr)` = col_character()
)) %>% 
  clean_names()

data2016 <- full_join(data_defense2016, data_offense2016, 
                      by = c("rk", "year", "player","pos", "av", "school", 
                             "college", "height", "wt", "x40yd", "vertical", 
                             "bench_reps", "broad_jump", "x3cone", "shuttle", 
                             "drafted_tm_rnd_yr"))

data_defense2015 <- read_csv("raw_data/2015Defense.csv", 
                         col_types = cols(
  Rk = col_double(),
  Year = col_double(),
  Player = col_character(),
  Pos = col_character(),
  AV = col_double(),
  School = col_character(),
  College = col_character(),
  Height = col_character(),
  Wt = col_double(),
  `40YD` = col_double(),
  Vertical = col_double(),
  BenchReps = col_double(),
  `Broad Jump` = col_double(),
  `3Cone` = col_double(),
  Shuttle = col_double(),
  `Drafted (tm/rnd/yr)` = col_character()
)) %>% 
  clean_names()

data_offense2015 <- read_csv("raw_data/2015Offense.csv",
                         col_types = cols(
  Rk = col_double(),
  Year = col_double(),
  Player = col_character(),
  Pos = col_character(),
  AV = col_double(),
  School = col_character(),
  College = col_character(),
  Height = col_character(),
  Wt = col_double(),
  `40YD` = col_double(),
  Vertical = col_double(),
  BenchReps = col_double(),
  `Broad Jump` = col_double(),
  `3Cone` = col_double(),
  Shuttle = col_double(),
  `Drafted (tm/rnd/yr)` = col_character()
)) %>% 
  clean_names()

data2015 <- full_join(data_defense2015, data_offense2015, 
                      by = c("rk", "year", "player","pos", "av", "school", 
                             "college", "height", "wt", "x40yd", "vertical", 
                             "bench_reps", "broad_jump", "x3cone", "shuttle", 
                             "drafted_tm_rnd_yr"))

data_defense2014 <- read_csv("raw_data/2014Defense.csv", 
                         col_types = cols(
  Rk = col_double(),
  Year = col_double(),
  Player = col_character(),
  Pos = col_character(),
  AV = col_double(),
  School = col_character(),
  College = col_character(),
  Height = col_character(),
  Wt = col_double(),
  `40YD` = col_double(),
  Vertical = col_double(),
  BenchReps = col_double(),
  `Broad Jump` = col_double(),
  `3Cone` = col_double(),
  Shuttle = col_double(),
  `Drafted (tm/rnd/yr)` = col_character()
)) %>% 
  clean_names()

data_offense2014 <- read_csv("raw_data/2014Offense.csv",
                         col_types = cols(
  Rk = col_double(),
  Year = col_double(),
  Player = col_character(),
  Pos = col_character(),
  AV = col_double(),
  School = col_character(),
  College = col_character(),
  Height = col_character(),
  Wt = col_double(),
  `40YD` = col_double(),
  Vertical = col_double(),
  BenchReps = col_double(),
  `Broad Jump` = col_double(),
  `3Cone` = col_double(),
  Shuttle = col_double(),
  `Drafted (tm/rnd/yr)` = col_character()
)) %>% 
  clean_names()

data2014 <- full_join(data_defense2014, data_offense2014, 
                      by = c("rk", "year", "player","pos", "av", "school", 
                             "college", "height", "wt", "x40yd", "vertical", 
                             "bench_reps", "broad_jump", "x3cone", "shuttle", 
                             "drafted_tm_rnd_yr"))

data_defense2013 <- read_csv("raw_data/2013Defense.csv", 
                         col_types = cols(
  Rk = col_double(),
  Year = col_double(),
  Player = col_character(),
  Pos = col_character(),
  AV = col_double(),
  School = col_character(),
  College = col_character(),
  Height = col_character(),
  Wt = col_double(),
  `40YD` = col_double(),
  Vertical = col_double(),
  BenchReps = col_double(),
  `Broad Jump` = col_double(),
  `3Cone` = col_double(),
  Shuttle = col_double(),
  `Drafted (tm/rnd/yr)` = col_character()
)) %>% 
  clean_names()

data_offense2013 <- read_csv("raw_data/2013Offense.csv",
                         col_types = cols(
  Rk = col_double(),
  Year = col_double(),
  Player = col_character(),
  Pos = col_character(),
  AV = col_double(),
  School = col_character(),
  College = col_character(),
  Height = col_character(),
  Wt = col_double(),
  `40YD` = col_double(),
  Vertical = col_double(),
  BenchReps = col_double(),
  `Broad Jump` = col_double(),
  `3Cone` = col_double(),
  Shuttle = col_double(),
  `Drafted (tm/rnd/yr)` = col_character()
)) %>% 
  clean_names()

data2013 <- full_join(data_defense2013, data_offense2013, 
                      by = c("rk", "year", "player","pos", "av", "school", 
                             "college", "height", "wt", "x40yd", "vertical", 
                             "bench_reps", "broad_jump", "x3cone", "shuttle", 
                             "drafted_tm_rnd_yr"))

data2017_2016 <- full_join(data2017, data2016, 
                      by = c("rk", "year", "player","pos", "av", "school", 
                             "college", "height", "wt", "x40yd", "vertical", 
                             "bench_reps", "broad_jump", "x3cone", "shuttle", 
                             "drafted_tm_rnd_yr"))

data2017_2016_2015 <- full_join(data2017_2016, data2015, 
                      by = c("rk", "year", "player","pos", "av", "school", 
                             "college", "height", "wt", "x40yd", "vertical", 
                             "bench_reps", "broad_jump", "x3cone", "shuttle", 
                             "drafted_tm_rnd_yr"))

data2017_2016_2015_2014 <- full_join(data2017_2016_2015, data2014, 
                      by = c("rk", "year", "player","pos", "av", "school", 
                             "college", "height", "wt", "x40yd", "vertical", 
                             "bench_reps", "broad_jump", "x3cone", "shuttle", 
                             "drafted_tm_rnd_yr"))

combine_data <- full_join(data2017_2016_2015_2014, data2013, 
                      by = c("rk", "year", "player","pos", "av", "school", 
                             "college", "height", "wt", "x40yd", "vertical", 
                             "bench_reps", "broad_jump", "x3cone", "shuttle", 
                             "drafted_tm_rnd_yr"))

combine_data <- combine_data %>% 
  separate(drafted_tm_rnd_yr,
c("team", "round", "pick_number"), " / ") 

combine_data <- combine_data %>% 
  separate(pick_number, c("pick_#", "extra"), "th pick")

combine_data <- combine_data %>% 
  separate(`pick_#`, c("pick", "extra_1"), "st pick")

combine_data <- combine_data %>% 
  separate(pick, c("pick", "extra_2"), "nd pick")

combine_data <- combine_data %>% 
  separate(pick, c("pick", "extra_3"), "rd pick")

combine_data <- combine_data %>% 
  select(-"extra") %>% 
  select(-"extra_1") %>% 
  select(-"extra_2") %>% 
  select(-"extra_3")
  

combine_data$pick <- as.numeric(as.character(combine_data$pick))

combine_data <- combine_data %>% 
  drop_na(pick)

write_rds(combine_data, "Athlete-Injuries/combine_data.rds")

combine_data %>% 
  pivot_longer(cols = c(x40yd, vertical, bench_reps, broad_jump, x3cone, shuttle), 
               names_to = "test", values_to = "result") %>% 
  group_by(test) %>% 
  summarise(average = mean(result, na.rm = TRUE), .groups = "drop")


   combine_data %>% 
        pivot_longer(cols = c(x40yd, vertical, bench_reps, broad_jump, x3cone, shuttle), 
                     names_to = "test", values_to = "result") %>% 
        group_by(test) %>% 
        summarise(nfl_average = mean(result, na.rm = TRUE), .groups = "drop") %>% 
        filter(test == "x40yd") -> nfl_average
      
      
      combine_data %>% 
        select(x40yd, vertical, bench_reps, broad_jump, x3cone, shuttle, team, pos) %>% 
        filter(team == "Pittsburgh Steelers",
               pos == "CB") %>% 
        pivot_longer(cols = c(x40yd, vertical, bench_reps, broad_jump, x3cone, shuttle), 
                     names_to = "test", values_to = "result") %>% 
        group_by(test) %>% 
        summarise(average = mean(result, na.rm = TRUE), .groups = "drop") %>% 
        filter(test == "x40yd") %>% 
        full_join(nfl_average)
      
      
   combine_data %>% 
        filter(pos %in% "DT") %>% 
        drop_na(x40yd) %>% 
        drop_na(broad_jump) -> testingdata
         
         
cor(testingdata$x40yd, testingdata$broad_jump, method = "spearman")
      
  
        
      
      combine_data %>% 
        filter(pos %in% "DT") %>% 
            ggplot(aes(x = x40yd, y = broad_jump)) + 
            geom_point() + 
        geom_smooth(method = "lm", se = FALSE) %>% 
        annotation_custom(grob1)
              
              
      
      
    fit <-  stan_glm(data = combine_data,
               formula = pick ~ x40yd,
               family = gaussian(),
               refresh = 0)
    
    print(fit)
    
    posterior <- as.array(fit)
    dim(posterior)
    dimnames(posterior)
    color_scheme_set("red")
    mcmc_areas(posterior, par= "x40yd")
    
   newdata <- combine_data %>% 
      select(pick, x40yd) %>% 
      drop_na(x40yd) %>% 
      head(1)
      
  posterior_predict(fit_40, newdata = newdata) %>% 
    as_tibble() %>% 
    ggplot(aes(x = `1`)) + 
    geom_histogram()
        
```

